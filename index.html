<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>NPC Bot Test (No-Module)</title>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #hud{
      position:fixed;left:14px;top:14px;z-index:10;max-width:92vw;
      background:rgba(0,0,0,.55);backdrop-filter:blur(8px);
      border:1px solid rgba(255,255,255,.12);border-radius:16px;
      padding:14px 14px 12px;color:#fff;
    }
    #row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    button{
      appearance:none;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);color:#fff;
      padding:10px 14px;border-radius:14px;font-weight:700;
    }
    button:active{transform:scale(.99)}
    #boot{font-weight:800;margin:6px 0 8px}
    #msg{opacity:.92;line-height:1.35}
    #diag{margin-top:10px;display:none;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap}
    #err{margin-top:10px;color:#ff6b6b;font-weight:800;white-space:pre-wrap;display:none}
    #dot{
      position:fixed;left:50%;top:50%;width:8px;height:8px;border-radius:999px;
      transform:translate(-50%,-50%);background:rgba(255,255,255,.7);z-index:2;
    }
    canvas{display:block}
  </style>
</head>
<body>
  <div id="hud">
    <div id="row">
      <button id="mouseBtn">Enable Mouse Look</button>
      <button id="resetBtn">Reset Position</button>
      <button id="diagBtn">Toggle Diagnostics</button>
      <button id="xrBtn" title="Will show WebXR availability">VR: Checking…</button>
    </div>
    <div id="boot">Booting…</div>
    <div id="msg">
      Controls: <b>WASD</b> move, <b>Shift</b> run, <b>Space</b> up, <b>C</b> down.<br/>
      NPC: <b>male avatar pedestal</b> + <b>male animated bot walking</b> around the table.<br/>
      This build is <b>NO-MODULE</b> + CDN scripts (mobile/GitHub Pages safe).
    </div>
    <div id="err"></div>
    <div id="diag"></div>
  </div>
  <div id="dot"></div>

  <!-- Three.js (global) -->
  <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
  <!-- Examples (global attach to THREE.*) -->
  <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://unpkg.com/three@0.128.0/examples/js/utils/SkeletonUtils.js"></script>
  <script src="https://unpkg.com/three@0.128.0/examples/js/webxr/VRButton.js"></script>

  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);
    const bootEl = $("boot"), diagEl=$("diag"), errEl=$("err");
    const mouseBtn=$("mouseBtn"), resetBtn=$("resetBtn"), diagBtn=$("diagBtn"), xrBtn=$("xrBtn");

    function setErr(msg){
      errEl.style.display = msg ? "block":"none";
      errEl.textContent = msg || "";
    }
    function setBoot(msg){ bootEl.textContent = msg; }

    // --- Basic checks
    try{
      if(!window.THREE) throw new Error("THREE not loaded");
      if(!THREE.GLTFLoader) throw new Error("GLTFLoader not loaded (THREE.GLTFLoader missing)");
    }catch(e){
      setErr("JS Error: " + e.message);
      setBoot("Stopped");
      return;
    }

    // --- Renderer / Scene
    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x050505, 6, 40);

    const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.05, 200);
    camera.position.set(0, 1.7, 7);

    const renderer = new THREE.WebGLRenderer({antialias:true, alpha:false});
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio||1, 2));
    renderer.outputEncoding = THREE.sRGBEncoding;
    renderer.shadowMap.enabled = true;
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    // VR button + status
    try{
      const vrBtn = VRButton.createButton(renderer);
      // Hide the ugly default button but still enable WebXR capability
      vrBtn.style.display = "none";
      document.body.appendChild(vrBtn);
    }catch(e){ /* ignore */ }

    if(navigator.xr){
      xrBtn.textContent = "VR: Available";
    }else{
      xrBtn.textContent = "VR: No WebXR";
    }
    xrBtn.onclick = ()=> {
      // Try to click hidden VRButton if present
      const hidden = document.querySelector('button[style*="display: none"]');
      if(hidden) hidden.click();
    };

    // --- Lights
    const hemi = new THREE.HemisphereLight(0xffffff, 0x111111, 0.9);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(6, 10, 4);
    dir.castShadow = true;
    dir.shadow.mapSize.set(1024,1024);
    scene.add(dir);

    // --- Floor
    const floor = new THREE.Mesh(
      new THREE.PlaneGeometry(200,200),
      new THREE.MeshStandardMaterial({color:0x0b0b0b, roughness:1.0, metalness:0.0})
    );
    floor.rotation.x = -Math.PI/2;
    floor.receiveShadow = true;
    scene.add(floor);

    // --- Big table centerpiece
    const tableGroup = new THREE.Group();
    const top = new THREE.Mesh(
      new THREE.CylinderGeometry(2.3,2.3,0.18,48),
      new THREE.MeshStandardMaterial({color:0x0e6b4c, roughness:0.9, metalness:0.05})
    );
    top.position.y = 1.0;
    top.castShadow = true;
    top.receiveShadow = true;

    const rim = new THREE.Mesh(
      new THREE.TorusGeometry(2.33, 0.10, 16, 64),
      new THREE.MeshStandardMaterial({color:0x2a1b10, roughness:0.8, metalness:0.1})
    );
    rim.position.y = 1.06;
    rim.rotation.x = Math.PI/2;
    rim.castShadow = true;

    const base = new THREE.Mesh(
      new THREE.CylinderGeometry(0.55,0.85,0.85,28),
      new THREE.MeshStandardMaterial({color:0x1a1a1a, roughness:0.8, metalness:0.15})
    );
    base.position.y = 0.55;
    base.castShadow = true;

    tableGroup.add(top, rim, base);
    tableGroup.position.set(0,0,0);
    scene.add(tableGroup);

    // --- Pedestal for display avatar
    const pedestal = new THREE.Mesh(
      new THREE.CylinderGeometry(0.55,0.65,0.35,24),
      new THREE.MeshStandardMaterial({color:0x202020, roughness:0.85, metalness:0.15})
    );
    pedestal.position.set(-3.2, 0.175, -0.8);
    pedestal.castShadow = true;
    pedestal.receiveShadow = true;
    scene.add(pedestal);

    // --- Simple movement
    const keys = new Set();
    window.addEventListener("keydown", (e)=>keys.add(e.code));
    window.addEventListener("keyup", (e)=>keys.delete(e.code));

    let mouseLook = false;
    let yaw = 0, pitch = 0;
    const euler = new THREE.Euler(0,0,0,"YXZ");

    function requestPointerLock(){
      renderer.domElement.requestPointerLock?.();
    }
    function exitPointerLock(){
      document.exitPointerLock?.();
    }
    document.addEventListener("pointerlockchange", ()=>{
      mouseLook = (document.pointerLockElement === renderer.domElement);
      mouseBtn.textContent = mouseLook ? "Disable Mouse Look" : "Enable Mouse Look";
    });
    mouseBtn.onclick = ()=>{
      if(!mouseLook) requestPointerLock();
      else exitPointerLock();
    };

    window.addEventListener("mousemove", (e)=>{
      if(!mouseLook) return;
      yaw   -= e.movementX * 0.0022;
      pitch -= e.movementY * 0.0022;
      pitch = Math.max(-1.3, Math.min(1.3, pitch));
    });

    resetBtn.onclick = ()=>{
      camera.position.set(0,1.7,7);
      yaw = 0; pitch = 0;
    };

    // --- Diagnostics
    let showDiag = false;
    diagBtn.onclick = ()=>{
      showDiag = !showDiag;
      diagEl.style.display = showDiag ? "block":"none";
    };

    // --- GLB loading (male only; female removed)
    const loader = new THREE.GLTFLoader();
    let displayAvatar = null;

    function safeLoad(url, onOk){
      loader.load(url, onOk, undefined, (err)=>{
        console.warn("GLB load failed:", url, err);
        setErr("Asset load failed: " + url + "\\n(If you renamed folders, check case-sensitive paths.)");
      });
    }

    // Display avatar on pedestal
    safeLoad("./assets/avatars/Character_output.glb", (gltf)=>{
      displayAvatar = gltf.scene;
      displayAvatar.traverse(o=>{ if(o.isMesh){ o.castShadow=true; o.receiveShadow=true; if(o.material) o.material.side = THREE.DoubleSide; }});
      displayAvatar.position.set(-3.2, 0.35, -0.8);
      displayAvatar.scale.setScalar(1.0);
      // face table
      displayAvatar.rotation.y = Math.PI/2;
      scene.add(displayAvatar);
      setBoot("World: Ready (display loaded)");
      setErr(""); // clear asset error if previously shown
    });

    // NPC bot (animated)
    let bot = null, botMixer = null, botAction = null;
    const waypoints = [
      new THREE.Vector3( 0.0, 0.0, -2.8),
      new THREE.Vector3( 2.6, 0.0, -0.2),
      new THREE.Vector3( 0.0, 0.0,  2.8),
      new THREE.Vector3(-2.6, 0.0, -0.2),
    ];
    let wp = 0;
    const tmp = new THREE.Vector3();
    const vel = new THREE.Vector3();

    safeLoad("./assets/avatars/Meshy_Merged_Animations.glb", (gltf)=>{
      // clone via SkeletonUtils for skinned meshes
      bot = THREE.SkeletonUtils.clone(gltf.scene);
      bot.traverse(o=>{ if(o.isMesh){ o.castShadow=true; o.receiveShadow=true; if(o.material) o.material.side = THREE.DoubleSide; }});
      bot.position.set(0,0, -3.3);
      bot.scale.setScalar(1.0);
      scene.add(bot);

      if(gltf.animations && gltf.animations.length){
        botMixer = new THREE.AnimationMixer(bot);
        // try to find walk/idle
        const walk = gltf.animations.find(a=>/walk/i.test(a.name)) || gltf.animations[0];
        botAction = botMixer.clipAction(walk);
        botAction.play();
      }
      setBoot("World: Ready (bot loaded)");
      setErr("");
    });

    function updateBot(dt){
      if(!bot) return;
      const target = waypoints[wp];
      tmp.copy(target).sub(bot.position);
      tmp.y = 0;
      const dist = tmp.length();
      if(dist < 0.25){
        wp = (wp+1) % waypoints.length;
        return;
      }
      tmp.normalize();
      const speed = 1.0;
      vel.copy(tmp).multiplyScalar(speed * dt);
      bot.position.add(vel);

      // face direction (prevents walking backwards)
      if(vel.lengthSq() > 1e-6){
        const yaw = Math.atan2(vel.x, vel.z);
        bot.rotation.y = yaw;
      }
    }

    // --- Resize
    window.addEventListener("resize", ()=>{
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });

    // --- Render loop starts immediately (no more “stuck booting”)
    let last = performance.now();
    let fps = 0, frames = 0, fpsT = 0;

    function step(now){
      const dt = Math.min(0.05, (now-last)/1000);
      last = now;

      // camera rotation from mouse look
      euler.set(pitch, yaw, 0);
      camera.quaternion.setFromEuler(euler);

      // movement
      const run = keys.has("ShiftLeft") || keys.has("ShiftRight");
      const speed = (run ? 6.0 : 3.2);
      const up = new THREE.Vector3(0,1,0);
      const forward = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
      forward.y = 0; forward.normalize();
      const right = new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion);
      right.y = 0; right.normalize();

      const move = new THREE.Vector3();
      if(keys.has("KeyW")) move.add(forward);
      if(keys.has("KeyS")) move.sub(forward);
      if(keys.has("KeyD")) move.add(right);
      if(keys.has("KeyA")) move.sub(right);
      if(keys.has("Space")) move.y += 1;
      if(keys.has("KeyC")) move.y -= 1;

      if(move.lengthSq()>0){
        move.normalize().multiplyScalar(speed*dt);
        camera.position.add(move);
      }

      // animation mixers
      if(botMixer) botMixer.update(dt);
      updateBot(dt);

      renderer.render(scene, camera);

      // fps + diag
      frames++; fpsT += dt;
      if(fpsT >= 0.5){
        fps = Math.round(frames / fpsT);
        frames = 0; fpsT = 0;
      }
      if(showDiag){
        diagEl.textContent =
          "FPS: " + fps + "\\n" +
          "Cam: " + camera.position.x.toFixed(2)+", "+camera.position.y.toFixed(2)+", "+camera.position.z.toFixed(2) + "\\n" +
          "XR enabled: " + renderer.xr.enabled + "\\n" +
          "Bot loaded: " + (!!bot) + "\\n" +
          "Display loaded: " + (!!displayAvatar) + "\\n" +
          "GLTFLoader: " + (typeof THREE.GLTFLoader);
      }
    }

    renderer.setAnimationLoop(step);

    // Show ready even if assets take time
    setBoot("World: Rendering… (assets loading in background)");
  })();
  </script>
</body>
</html>
